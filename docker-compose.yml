version: '2'
services:
  lb:
    restart: always
    image: 'dockercloud/haproxy:latest'
    ports:
      - '80:80'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    links:
      - frontend
      - api
      - adminer

  adminer:
    restart: always
    image: clue/adminer
    links:
      - db
    environment:
      VIRTUAL_HOST: http://adminer.manager.loc

  db:
    image: mysql:5.7
    restart: always
    volumes:
      - mysql:/var/lib/mysql
    environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: db
        MYSQL_USER: user
        MYSQL_PASSWORD: pass

  frontend:
    restart: always
    image: httpd
    volumes:
      - ./files/frontend/:/usr/local/apache2/htdocs/
    links:
      - api
    environment:
      VIRTUAL_HOST: http://manager.loc

  api:
    restart: always
    build: api
    volumes:
      - ./files/api/:/var/www/html/:rw
    links:
      - backend
    environment:
      VIRTUAL_HOST: http://api.manager.loc

  backend:
    restart: always
    build: backend
    volumes:
      - ./files/backend/:/var/www/html/:rw
    links:
      - db
    ports:
      - 88:80

volumes:
  mysql:
