version: '2'
services:
  lb:
    restart: always
    image: 'dockercloud/haproxy:latest'
    ports:
      - '80:80'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    links:
      - frontend
      - api
      - adminer
      - shinken

  adminer:
    restart: always
    image: clue/adminer
    links:
      - db
    environment:
      VIRTUAL_HOST: http://adminer.manager.loc

  db:
    image: mysql:5.7
    restart: always
    volumes:
      - mysql:/var/lib/mysql
    environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: db
        MYSQL_USER: user
        MYSQL_PASSWORD: pass

  frontend:
    restart: always
    image: httpd
    volumes:
      - ./files/frontend/:/usr/local/apache2/htdocs/
    links:
      - api
    environment:
      VIRTUAL_HOST: http://manager.loc

  api:
    restart: always
    image: formalibre/manager-api
    volumes:
      - ./files/api/:/var/www/html/:rw
    links:
      - backend
    environment:
      VIRTUAL_HOST: http://api.manager.loc

  backend:
    restart: always
    image: formalibre/manager-backend
    volumes:
      - ./files/backend/:/var/www/html/:rw
    links:
      - db
    ports:
      - 88:80

  shinken:
    restart: always
    environment:
      TZ: "UTC"  # UTC can be replaced by any valid timezone.
      VIRTUAL_HOST: http://shinken.manager.loc
    build: docker/shinken

    volumes:
       - ./docker/shinken/custom_configs:/etc/shinken/custom_configs
       - ./docker/shinken/extra_plugins:/usr/local/custom_plugins

  influxdb:
    image: influxdb
    restart: always
    ports:
      - 8086:8086
      - 8083:8083

volumes:
  mysql:
